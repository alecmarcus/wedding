"use server";

import { sendBulkEmail, sendRsvpConfirmationEmail } from "@@/email";
import { requestInfo } from "rwsdk/worker";
import { db } from "@/db";

export const getAllEmails = async () => {
  return await db.rsvp.findMany({
    select: {
      email: true,
      name: true,
    },
  });
};

export const resendConfirmationEmail = async (rsvpId: string) => {
  const { request } = requestInfo;
  const origin = new URL(request.url).origin;

  try {
    const rsvp = await db.rsvp.findUnique({
      where: {
        id: rsvpId,
      },
    });

    if (!rsvp) {
      return {
        success: false,
        error: "RSVP not found",
      };
    }

    await sendRsvpConfirmationEmail(rsvp, origin);

    return {
      success: true,
    };
  } catch (error) {
    return {
      success: false,
      error:
        error instanceof Error
          ? error.message
          : JSON.stringify(error) || "Unknown error",
    };
  }
};

export const sendBulkEmailToGuests = async (
  subject: string,
  content: string
) => {
  try {
    const rsvps = await db.rsvp.findMany({
      select: {
        email: true,
      },
    });

    const emails = rsvps.map(rsvp => rsvp.email);

    if (emails.length === 0) {
      return {
        success: false,
        error: "No RSVPs found",
      };
    }

    const data = await sendBulkEmail(emails, subject, content);

    return {
      success: true,
      data,
      error: null,
    };
  } catch (error) {
    return {
      success: false,
      data: null,
      error:
        error instanceof Error
          ? error.message
          : JSON.stringify(error) || "Failed to send bulk email",
    };
  }
};
